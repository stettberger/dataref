%%  Copyright 2013-2016 Christian Dietrich
%%
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
%% This work has the LPPL maintenance status `maintained'.
%%
%% The Current Maintainer of this work is Christian Dietrich
%%
%% This work consists of the files dataref.dtx and dataref.ins
%% and the derived file dataref.sty.
\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesPackage{dataref}[2015/09/17 v0.5 dataref]

\ifx\drefloaded\undefined
  \let\drefloaded=\relax
\else
  \expandafter\endinput
\fi

\def\drefutil@packageerror#1#2#3{\errhelp{#3}\errmessage{Package #1 Error: #2}}
\def\drefutil@packagewarning#1#2{\immediate\write17{Package #1: Warning! #2.}}
\def\dref@error#1{\drefutil@packageerror{dref}{#1}{}}
\def\dref@warning#1{\drefutil@packagewarning{dref}{#1}}

\RequirePackage{pgf}
\usepgflibrary{fpu}
\RequirePackage{iftex}
\RequirePackage{kvoptions}
\RequirePackage{etoolbox}

\SetupKeyvalOptions{
  family=dref,
  prefix=dref@
}
\DeclareStringOption[/data]{datapath}
\DeclareStringOption[1]{defaultvalue}
\DeclareStringOption[none]{annotate}
\DeclareBoolOption{usagereport}
\DeclareBoolOption{refall}
\DeclareBoolOption{ignoremissing}
\DeclareBoolOption{noassert}
\ProcessKeyvalOptions*

% Load & Store Layer

\def\dref@set#1#2{%
  \edef\dref@set@path{#1}%
  \edef\dref@set@value{#2}%
  \expandafter\pgfkeys@temptoks\expandafter{\dref@set@value}%
  \expandafter\xdef%
      \csname pgfk@\dref@datapath\dref@set@path\endcsname%
  {\the\pgfkeys@temptoks}%
  \ifdref@refall%
     \expandafter\dref@found\expandafter{\dref@set@path}{0}
     \expandafter\dref@referenced\expandafter{\dref@set@path}{0}%
  \fi%
}

\def\dref@load#1#2{%
  \edef\dref@load@path{#1}%
  \pgfkeysifdefined{\dref@datapath\dref@load@path}{%
    \pgfkeysgetvalue{\dref@datapath\dref@load@path}{#2}%
  }{%
    \edef#2{\dref@defaultvalue}%
  }%
}

\def\drefifdefined#1{%
  \pgfkeysifdefined{\dref@datapath\drefprefix #1}%{then}{else}
}

\def\dref@set@fromaux#1#2{%
  \drefifdefined{#1}{%
    \dref@warning{"\drefprefix #1" set before beginning of document, \string\drefsave{} is ignore}%
  }{%
    \dref@set{#1}{#2}%
  }%
}

\def\drefprefix{}
\def\drefkeys#1{\pgfkeys{/dref/.cd,#1}}

\drefkeys{
  .is family,
  .search also={/pgf/number format},
  % The @init action is used to initialize all other actions
  @init/.style={},
  % The \drefresult macro holds the current value,
  % it can be set by value=
  prefix/.estore in={\drefprefix},prefix={},
  value/.estore in={\drefresult},value=0,
  @init/.append style={},
  % \drefresult can be set by the @load action
  @load key to/.code 2 args={\dref@load{\drefprefix #1}{#2}},
  @load key/.style={@load key to={#1}{\drefresult}},
  @get key to/.style 2 args={
    @check key={#1},
    @reference key={#1},
    @load key to={#1}{#2},
  },
  @get key/.style={@get key to={#1}{\drefresult}},
  % For most commands, we want to check whether a key exists.
  @check key/.code={%
    \drefifdefined{#1}{}{%
      \ifdref@ignoremissing%
        \dref@warning{undefined key `#1'}%
      \else%
        \dref@error{undefined key `#1'}%
      \fi%
    }%
  },
  % The @set action is used to pipe out \drefresult, before we can
  % print it. For example, we can use it to save the result to a new
  % key.
  @init/.append style={@set/.code={}},
  set/.style={
    @set/.append code={%
      \dref@set{\drefprefix #1}{\drefresult}%
    }
  },
  save/.style={
    set={#1},
    @set/.append code={%
      \immediate\write\@auxout{%
        \noexpand\dref@set@fromaux{\drefprefix #1}{\drefresult}}%
    }
  },
  to macro/.style={
    @set/.append code={\edef#1{\drefresult}}
  },
  %
  ignoremissing/.is if={dref@ignoremissing},
}

\csdef{dref@ifnum@0}{}
\csdef{dref@ifnum@1}{}
\csdef{dref@ifnum@2}{}
\csdef{dref@ifnum@3}{}
\csdef{dref@ifnum@4}{}
\csdef{dref@ifnum@5}{}
\csdef{dref@ifnum@6}{}
\csdef{dref@ifnum@7}{}
\csdef{dref@ifnum@8}{}
\csdef{dref@ifnum@9}{}
\csdef{dref@ifnum@-}{}
\csdef{dref@ifnum@.}{}
\def\dref@load@ifkey@firstchar#1#2\@nnil{#1}
\drefkeys{%
  @get key or value to/.code 2 args={
    \edef\dref@load@path{#1}%
    \edef\dref@firstchar{\expandafter\dref@load@ifkey@firstchar \dref@load@path\@nnil}%
    \ifcsdef{dref@ifnum@\dref@firstchar}{%
      \edef#2{\dref@load@path}%
    }{%
      \drefkeys{@get key to={#1}{#2}}%
    }%
  },
  @get key or value/.style={@get key or value to={#1}{\drefresult}},
}


% Print layer
\drefkeys{
  @init/.append style={
    @print/.code={},
  },
  print/.is choice,
  print/no/.style={
    @print/.code={}
  },
  print/raw/.style={
    @print/.code={\drefresult}
  },
  print/typeout/.style={
    @print/.append code={\typeout{#1\drefresult}}
  },
  print/show/.style={
    @print/.append code={\show\drefresult},
  },
  print/pgf/.style={
    @print/.code={
      \pgfmathprintnumber{\drefresult}%
    }
  },
}

\def\drefset#1#2{\drefkeys{@init, value={#2}, set={#1}, @set}}
\def\drefsave#1#2{\drefkeys{@init, value={#2}, save={#1}, @set}}
\def\drefref#1{\drefkeys{@reference key={#1}}}

% From here on, everything should be implemented using pgfkeys
\protected\def\dref{\@ifstar\dref@starred\dref@unstarred}
\newcommand{\dref@unstarred}[2][]{% Unstarred
  \drefkeys{@init, print=pgf, @get key={#2}, #1, @print, @set,%
    @annotate={\textbackslash dref[#1]\{#2\}}%
  }%
}
\newcommand{\dref@starred}[2][]{%
  \drefkeys{@init, print=raw, @get key={#2}, #1, @print, @set,%
    @annotate={\textbackslash dref*[#1]\{#2\}}%
  }%
}
\def\drefgetvalue#1#2{%
  \drefkeys{@init, @get key={#1}, to macro={#2}, @set}%
}
\def\drefvalueof#1{%
  \drefkeys{@init, @check key={#1}, @load key={#1}, print=raw, @print}%
}

%% dref@ifstrmatch is copied from etextools, but etextools is
%% incompatible with etoolbox
%% \ifstrmatch{ pattern }{ string }{ true }{ false }
\ifPDFTeX%
  \let\dref@strmatch\pdfmatch
\fi
\ifLuaTeX%
 \newcommand{\dref@strmatch}[2]{%
  \directlua{%
    local match = string.find("\luaescapestring{#2}", "\luaescapestring{#1}");%
    if match then
      tex.print("1");
    else
      tex.print("0");
    end
  }%
}
\fi
\long\def\dref@firstoftwo#1#2{\z@#1} %% for romannumeral
\long\def\dref@secondoftwo#1#2{\z@#2}%% for romannumeral
\newcommand{\dref@ifstrmatch}[2]{%
  \romannumeral\csname dref@%
  \ifnum\dref@strmatch{#1}{#2}=1 first\else second\fi oftwo\endcsname%
}
\newcommand{\dref@help@match}[2]{%
  \dref@ifstrmatch{#1}{#2}%
}
\newcommand{\dref@help}[2][]{%
  \pgfkeysifdefined{#2/help}{%
    \pgfkeysvalueof{#2/help}%
  }{#1}%
}
\csdef{dref@helps}{}
\newcommand{\drefsethelp}[2]{
  \csdef{dref@help@#1}{#2}%
  \listcsadd{dref@helps}{#1}%
}
\newcommand{\drefhelp}[1]{
  \renewcommand{\do}[1]{%
    \dref@help@match{##1}{#1}{%
      \csuse{dref@help@##1}%
    \listbreak}{}%
  }%
  \ifcsvoid{dref@helps}{}{%
    \dolistcsloop{dref@helps}%
  }%
}
\drefkeys{
  @reference key/.code={%
    \edef\dref@thepage{\arabic{page}}%
    \drefifdefined{#1}{%
      \immediate\write\@auxout{%
        \noexpand\dref@found{\drefprefix #1}{\dref@thepage}}%
    }{%
      \immediate\write\@auxout{%
        \noexpand\dref@notfound{\drefprefix #1}{\dref@thepage}}%
    }%
    \immediate\write\@auxout{%
      \noexpand\dref@referenced{\drefprefix #1}{\dref@thepage}}%
  }
}
\def\dref@notfound#1#2{
  \ifdref@usagereport%
    \dref@usagereport@notfound{#1}{#2}%
  \else\relax\fi%
}
\def\dref@found#1#2{
  \ifdref@usagereport%
    \dref@usagereport@found{#1}{#2}%
  \else\relax\fi%
}
\def\dref@referenced#1#2{
  \ifdref@usagereport%
    \dref@usagereport@referenced{#1}{#2}%
  \else\relax\fi%
}
\drefkeys{
  let/.code={\dreflet{#1}}
}

\def\dreflet#1{%
  \def\@tmp##1=##2;{\pgfmathdeclarefunction*{##1}{0}{\pgfmathparse{##2}}}%
  \renewcommand*{\do}[1]{\@tmp##1;}%
  \ifstrempty{#1}{}{%
    \docsvlist{#1}%
  }%
}


% The data("") || d() Parser
\def\dref@parser#1#2{%
  \edef\@tempa{#1}%
  \csdef{dref@parser@result}{}%
  \csdef{dref@parser@state}{}%
  \expandafter\dref@parser@parse\@tempa\@nnil%
  \xdef#2{\csuse{dref@parser@result}}%
}

\def\dref@parser@parse#1#2\@nnil{%
  %\typeout{#1 State: \csuse{dref@parser@state}}%
  \ifblank{#1#2}{%
    \csxdef{dref@parser@result}{\csuse{dref@parser@result}\csuse{dref@parser@state}}%
  }{%
    \ifcsdef{dref@parser@\csuse{dref@parser@state}@#1}{%
      \csuse{dref@parser@\csuse{dref@parser@state}@#1}#2\@nnil%
    }{%
      \csxdef{dref@parser@result}{\csuse{dref@parser@result}\csuse{dref@parser@state}#1}%
      \csdef{dref@parser@state}{}%
      \ifblank{#2}{}{%
        \dref@parser@parse#2\@nnil%
      }%
    }%
  }%
}

\csdef{dref@parser@@d}{\csdef{dref@parser@state}{d}\dref@parser@parse}
\csdef{dref@parser@d@a}{\csdef{dref@parser@state}{da}\dref@parser@parse}
\csdef{dref@parser@da@t}{\csdef{dref@parser@state}{dat}\dref@parser@parse}
\csdef{dref@parser@dat@a}{\csdef{dref@parser@state}{data}\dref@parser@parse}
\csdef{dref@parser@data@(}{\csdef{dref@parser@state}{data(}\dref@parser@parse}
\csdef{dref@parser@data(@"}{\dref@parser@tillquote}
\csdef{dref@parser@d@(}{\dref@parser@tillparen}

\def\dref@parser@tillquote#1")#2\@nnil{%
  \drefref{#1}%
  \drefgetvalue{#1}{\dref@math@value}%
  \csxdef{dref@parser@result}{\csuse{dref@parser@result}(\dref@math@value)}%
  \csdef{dref@parser@state}{}%
  \ifblank{#2}{}{\dref@parser@parse#2\@nnil}}

\def\dref@parser@tillparen#1)#2\@nnil{%
  \drefref{#1}%
  \drefgetvalue{#1}{\dref@math@value}%
  \csxdef{dref@parser@result}{\csuse{dref@parser@result}(\dref@math@value)}%
  \csdef{dref@parser@state}{}%
  \ifblank{#2}{}{\dref@parser@parse#2\@nnil}}%

\def\dref@parser@end#1#2\@nnil{}
\csdef{dref@parser@@}{\dref@parser@end}

\drefkeys{
  @init/.append style={%
    @calc/.code={},%
  },
  @calc pgf/.style={
    @calc/.append code={%
      \dref@parser{#1}{\dref@calc@@argA}%
      \pgfmathparse{\dref@calc@@argA}%
      \pgfmathprintnumberto[fixed,assume math mode=true,%
                            precision=10,1000 sep={}]%
                            {\pgfmathresult}{\drefresult}%
      \xdef\drefresult{\drefresult}%
    }
  }
}

\protected\def\drefcalc{\@ifstar\drefcalc@starred\drefcalc@unstarred}
\newcommand{\drefcalc@unstarred}[2][]{% Unstarred
  \drefkeys{@init, print=pgf, @calc pgf={#2}, #1, @calc, @print, @set,%
            @annotate={\textbackslash drefcalc[#1]\{#2\}}}%
}
\newcommand{\drefcalc@starred}[2][]{ % Starred
  \drefkeys{@init, @calc pgf={#2}, #1, @calc, @set,%
    @annotate={\textbackslash \drefcalc*[#1]\{#2\}}%
  }%
}
\newcommand{\dref@format}[2][]{%
  \pgfmathprintnumber[#1]{#2}%
}
\newcommand{\drefformat}[2][]{%
  \drefkeys{@init, value={#2}, #1, @print, @set}%
}

\pgfmathdeclarefunction{data}{1}{%
  \begingroup%
    \drefref{#1}%
    \drefgetvalue{#1}{\dref@math@value}%
    \pgfmathparse{\dref@math@value}%
    \pgfmath@smuggleone\pgfmathresult%
  \endgroup%
}
\long\def\drefprojection#1#2#3{%
  \begingroup%
  \def\rename##1##2{%
    \drefkeys{@init, @get key={#1/##1}, set={#2/##2}, @set}%
  }%
  \def\id##1{\rename{##1}{##1}}%
  \def\calc##1##2{%
    \edef\drefprojection@prefix{\drefprefix}%
    \drefcalc[prefix={#1}]{##1}%
    \edef\drefprefix{\drefprojection@prefix}%
    \drefset{#2/##2}{\drefresult}%
  }%
  #3%
  \endgroup%
}


\newtoks\dref@toks
\newcount\drefcellcount

\newcommand{\dref@makerow}[2]{%
  {\global\dref@toks={}%
    \drefcellcount=\z@%
    \def\do##1{%
      \advance\drefcellcount\@ne%
      \def\@tempa{\doX{##1}}%
      \expandafter\@tempa\expandafter{\the\drefcellcount}%
    }%
    \def\doX##1##2{%
      \csxdef{@cell\the\drefcellcount}{\detokenize{%
          #2%
        }}%
    }%
    \expandafter\def\expandafter\arglist\expandafter{#1}%
    \expandafter\docsvlist\expandafter{\arglist}%
    \@tempcntb=0\relax%
    {\loop\ifnum\@tempcntb<\drefcellcount%
      \advance\@tempcntb by 1\relax%
      \ifnum \@tempcntb = 1%
        \edef\@@next{\csuse{@cell\the\@tempcntb}}%
      \else%
        \edef\@@next{&\csuse{@cell\the\@tempcntb}}%
      \fi%
      \global%
      \dref@toks%
      \expandafter=%
      \expandafter{%
        \the%
        \expandafter\dref@toks%
        \@@next}%
      \repeat}%
  }%
  \expandafter\scantokens\expandafter{\the\dref@toks}%
}

\long\def\drefrow{\@ifstar{\drefrow@starred}{\drefrow@unstarred}}
\def\drefrow@unstarred#1#2{\dref@makerow{#1}{\dref{#2}}\ignorespaces}
\def\drefrow@starred#1#2{\dref@makerow{#1}{#2}\ignorespaces}

\expandafter\ifstrequal\expandafter{\dref@annotate}{pdfcomment}{
  \RequirePackage{pdfcomment}
}


\drefkeys{
  annotate/.is choice,
  annotate/none/.style={@annotate/.code={\relax}},
  annotate/footnote/.style={@annotate/.code={\footnote{\texttt{##1}}}},
  annotate/pdfcomment/.style={@annotate/.code={\pdfcomment[opacity=0.4,voffset=2ex]{##1}}},
  annotate/typeout/.style={@annotate/.code={\typeout{##1}}},
  annotate=\dref@annotate,
}

%% Usagereport
\ifdref@usagereport
  \RequirePackage{xtab}
  \RequirePackage{booktabs}
\fi
\newcommand{\dref@usagereport@notfound}[2]{}
\newcommand{\dref@usagereport@found}[2]{}

\csdef{pgfdat@usagereport@keys}{}
\csdef{pgfdat@usagereport@matchedkeys}{}

\newcommand{\dref@usagereport@referenced}[2]{
  \ifinlistcs{#2}{dref@usagereport@referenced@#1}{}{
    \listcsgadd{dref@usagereport@referenced@#1}{#2}
  }
  \ifinlistcs{#1}{dref@usagereport@keys}{}{
    \listcsgadd{dref@usagereport@keys}{#1}
  }
}
\expandafter\def\expandafter\dref@usagereport@strippath@\dref@datapath#1\blanktest{#1}

\newcommand{\dref@usagereport@strippath}[1]{%
  \expandafter\dref@ifstrmatch\expandafter{\expandafter^\dref@datapath.*$}{#1}%$
    {\dref@usagereport@strippath@#1\blanktest}%
    {#1}%
}
\newcommand{\dref@usagereport@formatreferencelist}[1]{%
  \begingroup%
  \def\sep{}%
  \renewcommand{\do}[1]{\sep\ifdef{\hyperlink}{\hyperlink{page.##1}{##1}}{##1}\def\sep{, }}%
  \dolistcsloop{dref@usagereport@referenced@#1}%
  \endgroup%
}
\newif\ifdref@usagereport@keyheader@first
\dref@usagereport@keyheader@firsttrue
\newcommand{\dref@usagereport@keyheader}[1]{%
  \ifdref@usagereport@keyheader@first%
  \global\dref@usagereport@keyheader@firstfalse%
  \else%
    \\%
  \fi%
  \textbf{\ifdef{\hypertarget}%
    {\hypertarget{#1}{\dref@usagereport@strippath{#1}}}%
    {\dref@usagereport@strippath{#1}}}%
  & \dref@usagereport@formatreferencelist{#1}%
  & \drefifdefined{#1}{\drefvalueof{#1}}{\textbf{undefined}}%
}

\def\drefusagereportaftergroup{}

\def\drefusagereportbeforerow{}
\def\drefusagereportbeforetitle{}
\def\drefusagereportaftertitle{}

\def\drefusagereportbeforedescription{}


\newif\ifdref@withhelp
\errorcontextlines=23
\newlength{\dreflinewidth}%
\newcommand{\dref@usagereport@forhelp}[1]{%
  \begingroup%
  \dref@withhelpfalse%
  \renewcommand{\do}[1]{%
    \dref@help@match{#1}{##1}{%
      \dref@withhelptrue%
    }{}%
  }%
  \dolistcsloop{dref@usagereport@keys}%
  \dref@usagereport@keyheader@firsttrue%
  \renewcommand{\do}[1]{%
    \dref@help@match{#1}{##1}{%
      \drefusagereportbeforerow%
      \dref@usagereport@keyheader{##1}%
      \ifinlistcs{##1}{dref@usagereport@matchedkeys}{}{%
        \listcsgadd{dref@usagereport@matchedkeys}{##1}%
      }%
    }{}%
  }%
  \ifdref@withhelp
    \tablehead{\drefusagereportbeforetitle%
      \hline      & Page  & Value %
      \drefusagereportaftertitle\\\hline%
    }%
    \setlength\tabcolsep{3pt}%
    \dreflinewidth=\linewidth%
    \advance\dreflinewidth by -4\tabcolsep%
    \advance\dreflinewidth by -2\arrayrulewidth%
    \begin{xtabular}{|p{0.7\dreflinewidth}|p{0.15\dreflinewidth}|p{0.15\dreflinewidth}|}%
      \dolistcsloop{dref@usagereport@keys}\\\hline
      \drefusagereportbeforedescription%
      \multicolumn{3}{|p{\linewidth}|}{\csuse{dref@help@#1}}\\\hline
    \end{xtabular}%
  \fi%
  \drefusagereportaftergroup%

  \endgroup%
}
\newif\ifdref@withouthelp
\newcommand{\dref@usagereport@withouthelp}{%
  \begingroup%
  \dref@withouthelpfalse%
  \renewcommand{\do}[1]{%
    \ifinlistcs{##1}{dref@usagereport@matchedkeys}{}{%
      \dref@withouthelptrue%
    }%
  }%
  \dolistcsloop{dref@usagereport@keys}%
  \dref@usagereport@keyheader@firsttrue%
  \renewcommand{\do}[1]{%
    \ifinlistcs{##1}{dref@usagereport@matchedkeys}{}{%
      \drefusagereportbeforerow%
      \dref@usagereport@keyheader{##1}%
    }%
  }%
  \ifdref@withouthelp%
    \tablehead{\drefusagereportbeforetitle%
      \hline Keys without Description     & Page  & Value %
      \drefusagereportaftertitle\\\hline%
    }%
    \setlength\tabcolsep{3pt}%
    \dreflinewidth=\linewidth%
    \advance\dreflinewidth by -4\tabcolsep%
    \advance\dreflinewidth by -2\arrayrulewidth%
    \begin{xtabular}{|p{0.7\dreflinewidth}|p{0.15\dreflinewidth}|p{0.15\dreflinewidth}|}%
      \dolistcsloop{dref@usagereport@keys}\\\hline
      \drefusagereportbeforedescription%
      \multicolumn{3}{|p{\linewidth}|}{%
        \emph{For these keys, no description was given}}\\\hline
    \end{xtabular}%
   \fi%
   \endgroup%
}
\newcommand{\drefusagereport}{%
  \ifdref@usagereport%
  \ifcsvoid{dref@usagereport@keys}{}{%
  \begingroup%
  \renewcommand{\do}[1]{%
    \ifinlistcs{##1}{dref@usagereport@matchedkeys}{}{%
      \dref@usagereport@forhelp{##1}%
    }%
  }%
  \dolistcsloop{dref@helps} % For all help text
  \dref@usagereport@withouthelp\relax
  \endgroup%
  }% csempty @keys
  \fi%
}
\newcommand{\drefassert}[1]{%
  \begingroup%
    \drefcalc*{#1}%
    \expandafter\ifstrequal\expandafter{\drefresult}{1}{%
      \dref@warning{Assertion holds: #1}%
    }{%
      \ifdref@noassert%
        \dref@warning{Assertion failed: #1}%
      \else%
        \dref@error{Assertion failed: #1}%
      \fi%
   }%
  \endgroup%
}
\drefkeys{%
  factor of/.style={%
    @get key or value to={#1}{\drefrel@tmp},%
    @calc pgf/.expanded={(\noexpand\drefresult)/(\drefrel@tmp)}
  },
  percent/.style={
    @calc pgf={100 * (\drefresult)},
  },
  percent of/.style={
    factor of=#1, percent,
  },
  scale by/.style={
    @get key or value to={#1}{\drefrel@tmp},%
    @calc pgf/.expanded={(\drefrel@tmp) * (\noexpand\drefresult)},
  },
  product/.style={scale by={#1}},
  divide by/.style={
    @get key or value to={#1}{\drefrel@tmp},%
    @calc pgf/.expanded={(\drefrel@tmp) / (\noexpand\drefresult)},
  },
  divide/.style={divide by},
  product/.style={scale by={#1}},
  overhead of/.style={
    @get key or value to={#1}{\drefrel@tmp},%
    @calc pgf/.expanded={((\noexpand\drefresult)-(\drefrel@tmp))/(\drefrel@tmp)},
  },
  increase by/.style={overhead of={#1}},
  delta/.style={
    @get key or value to={#1}{\drefrel@tmp},%
    @calc pgf/.expanded={((\noexpand\drefresult)-(\drefrel@tmp))},
  },
  abs/.style={
    @calc pgf={abs(\drefresult)}
  },
  negate/.style={
    @calc pgf={-1 * (\drefresult)}
  },
}

\def\drefrel{\@ifstar\drefrel@starred\drefrel@unstarred}

\newcommand{\drefrel@unstarred}[2][]{%
  \drefkeys{@init, print=pgf, @get key or value={#2}, #1, @calc, @print, @set,%
    @annotate={\textbackslash drefrel[#1]\{#2\}}}
}

\newcommand{\drefrel@starred}[2][]{%
  \drefkeys{@init, @get key or value={#2}, #1, @calc, @print, @set,%
    @annotate={\textbackslash drefrel[#1]\{#2\}}}
}

\endinput
%%
%% End of file `dataref.sty'.
